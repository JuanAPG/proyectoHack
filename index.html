<html lang="es" data-bs-theme="dark">
    <html lang="es">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>gategroup - Task Manager</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
<style>
:root{
  --accent: #063de3;          /* rojo acento (ajústalo si quieres) */
  --bg-0: #0b0c0f;            /* fondo principal */
  --bg-1: #121418;            /* fondo secundario */
  --bg-2: #181b21;            /* superficies (cards) */
  --bd-1: #262a30;            /* bordes sutiles */
  --tx-0: #f2f3f5;            /* texto principal */
  --tx-1: #c9cdd4;            /* texto secundario */
  --muted: #8a9099;           /* texto apagado */
}

html, body{ background: var(--bg-0); color: var(--tx-0); }
img{height: 2rem;}

/* Cards, listas, modales */
.card, .list-group-item, .modal-content{
  background: var(--bg-2);
  border-color: var(--bd-1);
  color: var(--tx-0);
}
.list-group-item{ border-color: var(--bd-1); }

/* Tabs */
.nav-tabs{ border-color: var(--bd-1); }
.nav-tabs .nav-link{ color: var(--tx-1); border-color: transparent; }
.nav-tabs .nav-link:hover{ color: #fff; }
.nav-tabs .nav-link.active{
  color: #fff;
  background: var(--bg-2);
  border-color: var(--bd-1) var(--bd-1) var(--bg-2);
  border-bottom: 2px solid var(--accent);
}

/* Botones */
.btn-primary{
  background: var(--accent);
  border-color: var(--accent);
}
.btn-outline-primary{
  color: var(--accent);
  border-color: var(--accent);
}
.btn-outline-primary:hover{
  background: color-mix(in oklab, var(--accent) 15%, transparent);
  border-color: var(--accent);
}
.btn-outline-secondary{
  color: var(--tx-1);
  border-color: var(--bd-1);
}
.btn-outline-secondary:hover{
  background: var(--bg-1);
  border-color: var(--bd-1);
}

/* Badges de rol */
.role-pill{ font-weight:600; }
.role-Lider{ background: var(--accent) !important; }
.role-Operativo{ background: #2fbf71 !important; }  /* verde elegante */
.role-Soporte{ background: #6c757d !important; }    /* gris */

/* Pills de categoría (fondos translúcidos en dark) */
.cat-pill{ font-size:.75rem; color:#fff; }
.cat-Bebidas{ background: rgba(255,160,0,.25); border:1px solid rgba(255,160,0,.35); }
.cat-Servicio{ background: rgba(0,173,255,.20); border:1px solid rgba(0,173,255,.30); }
.cat-Comida{ background: rgba(255,0,128,.22); border:1px solid rgba(255,0,128,.32); }
.cat-QC{ background: rgba(0,200,120,.22); border:1px solid rgba(0,200,120,.32); }

/* Tarjetas de tarea (colaborador) */
.task-card{
  border:1px solid var(--bd-1);
  border-radius:.75rem;
  padding:1rem;
  background: var(--bg-2);
}
.task-card .title{ font-weight:600; }

/* Contenedores y headers */
.card-header.bg-white{ background: var(--bg-1) !important; }

/* Bordered helpers */
.suggested{ outline: 2px dashed var(--accent); border-radius:.5rem; }

/* Progress bar y toasts en dark ya respetan data-bs-theme, pero afinamos contraste */
.progress{ background: #1f232b; }
.progress-bar{ background: var(--accent); }

.toast.text-bg-primary{ background: var(--accent) !important; }

</style>
</head>
<body>
<div class="container py-4">

  <div class="d-flex justify-content-between align-items-center mb-3">
    <img src="https://cdn.cookielaw.org/logos/9a3365cc-3965-4e9f-b352-94c317b6fafe/1fadf2c5-d63a-45c3-b947-c823ecbed0c6/09da9c3d-b5e7-4472-ad10-fcc50494632e/gategroup_Logo_White_RGB_PNG(4).png"/>
    <h1 class="h4 mb-0">Task Manager</h1>
    <div class="d-flex gap-2">
      <button class="btn btn-outline-secondary btn-sm" id="btnSeed">Reiniciar demo</button>
    </div>
  </div>

  <!-- Tabs -->
  <ul class="nav nav-tabs mb-3" role="tablist">
    <li class="nav-item" role="presentation">
      <button class="nav-link active" data-bs-toggle="tab" data-bs-target="#leader" type="button" role="tab">Vista Líder</button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link" data-bs-toggle="tab" data-bs-target="#worker" type="button" role="tab">Vista Colaborador</button>
    </li>
  </ul>

  <div class="tab-content">

    <!-- ===================== LÍDER ===================== -->
    <div class="tab-pane fade show active" id="leader" role="tabpanel">
      <div class="row g-4">

        <!-- Controles -->
        <div class="col-12">
          <div class="card">
            <div class="card-body row g-3 align-items-center">
              <div class="col-md-4">
                <label class="form-label mb-1"><strong>α</strong> peso de prioridad vs balanceo</label>
                <input type="range" class="form-range" id="alpha" min="0" max="1" step="0.05" value="0.6">
                <div class="small text-muted">0 = balance/carga • 1 = prioridad pura</div>
              </div>
              <div class="col-md-4">
                <label class="form-label mb-1">Anti-repetición (últimas N tareas)</label>
                <input type="number" id="varWindow" class="form-control" value="3" min="1" max="10">
              </div>
              <div class="col-md-4">
                <label class="form-label mb-1">Máx. tareas simultáneas por colaborador</label>
                <input type="number" id="maxTasks" class="form-control" value="3" min="1" max="8">
              </div>
            </div>
          </div>
        </div>

        <!-- Empleados -->
        <div class="col-lg-4">
          <div class="card h-100">
            <div class="card-header bg-white">
              <h5 class="mb-0">Equipos & Colaboradores</h5>
              <small class="text-muted">Carga y variedad reciente</small>
            </div>
            <div class="card-body" id="empList"></div>
          </div>
        </div>

        <!-- Backlog -->
        <div class="col-lg-4">
          <div class="card h-100">
            <div class="card-header bg-white d-flex justify-content-between align-items-center">
              <div>
                <h5 class="mb-0">Tareas del día</h5>
                <small class="text-muted">Prioridad, esfuerzo y categoría</small>
              </div>
              <div>
                <button class="btn btn-sm btn-outline-secondary me-2" id="btnAddTask" data-bs-toggle="modal" data-bs-target="#addTaskModal">+ Task</button>
                <button class="btn btn-sm btn-outline-danger" id="btnClearDone">Limpiar hechas</button>
              </div>
            </div>
            <div class="list-group list-group-flush" id="taskList"></div>
          </div>
        </div>

        <!-- Sugerencias + Incidencias -->
        <div class="col-lg-4">
          <div class="card h-100 suggested mb-4">
            <div class="card-header bg-white">
              <h5 class="mb-0">Sugerencia de la IA</h5>
            </div>
            <div class="card-body">
              <div id="suggBox" class="mb-3 text-muted">Pulsa “Sugerir siguiente”.</div>
              <div class="d-grid gap-2">
                <button class="btn btn-primary" id="btnSuggest">Sugerir siguiente</button>
                <button class="btn btn-success" id="btnAssign">Asignar sugerencia</button>
                <button class="btn btn-outline-primary" id="btnAuto">Auto-asignar (demo)</button>
              </div>
            </div>
          </div>

          <div class="card h-100">
            <div class="card-header bg-white">
              <h5 class="mb-0">Incidencias reportadas</h5>
              <small class="text-muted">Colaboradores que requieren apoyo</small>
            </div>
            <div class="list-group list-group-flush" id="issuesList">
              <div class="list-group-item text-muted">Sin incidencias por ahora.</div>
            </div>
          </div>
        </div>

      </div>
    </div>

    <!-- ===================== COLABORADOR ===================== -->
    <div class="tab-pane fade" id="worker" role="tabpanel">
      <div class="row g-4">

        <!-- Selector de colaborador -->
        <div class="col-12">
          <div class="card">
            <div class="card-body row g-3 align-items-center">
              <div class="col-md-5">
                <label class="form-label mb-1">Soy</label>
                <select id="workerSelect" class="form-select"></select>
              </div>
              <div class="col-md-7">
                <div class="d-flex gap-3 align-items-center">
                  <div class="badge text-bg-success badge-large" id="pointsBadge">0 pts</div>
                  <div id="badgesBox" class="d-flex flex-wrap gap-2"></div>
                </div>
                <div class="small text-muted mt-2" id="varietyHint">Variedad: 0 categorías esta semana.</div>
                <div class="mt-2">
                  <span class="fw-semibold">Logros destacados:</span>
                  <span id="achievementsBox" class="ms-2 text-muted">—</span>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Mis tareas -->
        <div class="col-lg-7">
          <div class="card h-100">
            <div class="card-header bg-white">
              <h5 class="mb-0">Mis tareas asignadas</h5>
              <small class="text-muted">Marca completadas o reporta problemas</small>
            </div>
            <div class="p-3" id="myTasks"></div>
          </div>
        </div>

        <!-- Gamificación / Progreso -->
        <div class="col-lg-5">
          <div class="card h-100">
            <div class="card-header bg-white">
              <h5 class="mb-0">Progreso & Gamificación</h5>
              <small class="text-muted">Racha, diversidad y logros</small>
            </div>
            <div class="card-body">
              <div class="mb-3">
                <div class="fw-semibold">Racha de días productivos</div>
                <div class="progress" role="progressbar" aria-label="Streak">
                  <div class="progress-bar" id="streakBar" style="width:0%">0/5</div>
                </div>
                <div class="small text-muted mt-1">Completa al menos 3 tareas diarias para avanzar la racha (meta 5).</div>
              </div>
              <div>
                <div class="fw-semibold">Diversidad de tareas</div>
                <div id="diversityCats" class="d-flex flex-wrap gap-2 mt-1"></div>
                <div class="small text-muted">Gana el badge <em>“Todo Terreno”</em> al completar 3+ categorías distintas en un día.</div>
              </div>
            </div>
          </div>
        </div>

      </div>
    </div>

  </div>
</div>

<!-- Modal: Añadir tarea -->
<div class="modal fade" id="addTaskModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <form class="modal-content" id="addTaskForm">
      <div class="modal-header">
        <h5 class="modal-title">Nueva tarea</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
      </div>
      <div class="modal-body">
        <div class="mb-3">
          <label class="form-label">Título</label>
          <input type="text" class="form-control" id="fTitle" required placeholder="Ej. Trolley LX721">
        </div>
        <div class="row g-3">
          <div class="col-md-6">
            <label class="form-label">Rol requerido</label>
            <select id="fRole" class="form-select" required>
              <option>Operativo</option>
              <option>Soporte</option>
              <option>Lider</option>
            </select>
          </div>
          <div class="col-md-3">
            <label class="form-label">Prioridad (1–5)</label>
            <input type="number" id="fPriority" class="form-control" min="1" max="5" value="3" required>
          </div>
          <div class="col-md-3">
            <label class="form-label">Esfuerzo (1–3)</label>
            <input type="number" id="fEffort" class="form-control" min="1" max="3" value="1" required>
          </div>
        </div>
        <div class="mt-3">
          <label class="form-label">Categoría</label>
          <select id="fCategory" class="form-select" required>
            <option>Bebidas</option>
            <option>Servicio</option>
            <option>Comida</option>
            <option>QC</option>
          </select>
        </div>
        <div class="mt-3">
          <label class="form-label">Notas (opcional)</label>
          <textarea id="fNotes" class="form-control" rows="2" placeholder="Detalle adicional..."></textarea>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" data-bs-dismiss="modal" type="button">Cancelar</button>
        <button class="btn btn-primary" type="submit">Añadir</button>
      </div>
    </form>
  </div>
</div>

<!-- Modal: Asignar tarea (nuevo) -->
<div class="modal fade" id="assignModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <form class="modal-content" id="assignForm">
      <div class="modal-header">
        <h5 class="modal-title">Asignar tarea</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
      </div>
      <div class="modal-body">
        <input type="hidden" id="assignTaskId">
        <div class="mb-2">
          <div class="fw-semibold" id="assignTaskTitle">—</div>
          <div class="small text-muted" id="assignTaskMeta">Rol requerido • Prioridad • Esfuerzo • Categoría</div>
        </div>
        <div class="mt-3">
          <label class="form-label">Colaboradores (puedes elegir varios)</label>
          <select id="assignSelect" class="form-select" multiple size="6"></select>
          <div class="form-text">Solo se muestran colaboradores con el **rol requerido** de la tarea.</div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" data-bs-dismiss="modal" type="button">Cancelar</button>
        <button class="btn btn-success" type="submit">Asignar</button>
      </div>
    </form>
  </div>
</div>

<!-- Modal: Reportar problema -->
<div class="modal fade" id="issueModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <form class="modal-content" id="issueForm">
      <div class="modal-header">
        <h5 class="modal-title">Reportar problema</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
      </div>
      <div class="modal-body">
        <input type="hidden" id="issueTaskId">
        <div class="mb-3">
          <label class="form-label">Describe el problema</label>
          <textarea id="issueText" class="form-control" rows="3" required placeholder="Ej. Falta insumo / bloqueo con equipo / duda de especificación"></textarea>
        </div>
        <div class="row g-3">
          <div class="col-md-6">
            <label class="form-label">Severidad</label>
            <select id="issueSeverity" class="form-select">
              <option value="media">Media</option>
              <option value="alta">Alta</option>
              <option value="baja">Baja</option>
            </select>
          </div>
          <div class="col-md-6">
            <label class="form-label">¿Requiere ayuda del líder?</label>
            <select id="issueNeedHelp" class="form-select">
              <option value="si">Sí</option>
              <option value="no">No</option>
            </select>
          </div>
        </div>
        <div class="mt-3 small text-muted">Se notificará al panel de incidencias del líder.</div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" data-bs-dismiss="modal" type="button">Cancelar</button>
        <button class="btn btn-danger" type="submit">Enviar incidencia</button>
      </div>
    </form>
  </div>
</div>

<!-- Toasts -->
<div class="position-fixed bottom-0 end-0 p-3" style="z-index: 1080">
  <div id="toast" class="toast align-items-center text-bg-primary border-0" role="alert" aria-live="assertive" aria-atomic="true">
    <div class="d-flex">
      <div class="toast-body" id="toastMsg">Notificación</div>
      <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
/* ------------------- DEMO DATA ------------------- */
const CATS = ["Bebidas","Servicio","Comida","QC"];
let employees, tasks, assignments, workerMeta, issues;

function seed(){
  employees = [
    {id:"EMP01", name:"Ana", role:"Lider", group:"A", load:0, recentCats:[], points:0, badges:[], streak:0, achievements:["Mentora destacada"]},
    {id:"EMP02", name:"Luis", role:"Operativo", group:"A", load:0, recentCats:[], points:0, badges:["Todo Terreno"], streak:1, achievements:["100% puntualidad","Cero rework (semana)"]},
    {id:"EMP03", name:"Sara", role:"Operativo", group:"A", load:0, recentCats:[], points:0, badges:[], streak:0, achievements:["Soporte crítico en pico"]},
    {id:"EMP04", name:"Diego", role:"Soporte", group:"B", load:0, recentCats:[], points:0, badges:[], streak:0, achievements:["Capacitó a 2 novatos"]},
    {id:"EMP05", name:"María", role:"Soporte", group:"B", load:0, recentCats:[], points:0, badges:["Alta Productividad"], streak:2, achievements:["Top 3 productividad"]},
    {id:"EMP06", name:"Iván", role:"Operativo", group:"B", load:0, recentCats:[], points:0, badges:[], streak:0, achievements:["Optimización de layout"]},
  ];
  tasks = [
    t("T001","Trolley LX721","Operativo",5,2,"Servicio"),
    t("T002","Reposición bebidas EK088","Soporte",3,1,"Bebidas"),
    t("T003","QC final BA215","Lider",4,1,"QC"),
    t("T004","Cubertería AF178","Operativo",2,1,"Servicio"),
    t("T005","Bandejas calientes LH490","Operativo",5,3,"Comida"),
    t("T006","Inventario bar 1A","Soporte",3,1,"Bebidas"),
  ];
  assignments = []; // {taskId, empId, status:'pending'|'done'|'blocked', category}
  workerMeta = {selected:"EMP02"};
  issues = []; // {id, taskId, empId, text, severity, needHelp, ts, status}
}
const t = (id,title,reqRole,priority,effort,cat)=>({id,title,reqRole,priority,effort,cat});
seed();

/* ------------------- UTIL ------------------- */
const $ = s => document.querySelector(s);
const $$ = s => Array.from(document.querySelectorAll(s));
const badgeRole = r => `<span class="badge role-pill role-${r} text-white ms-1">${r}</span>`;
const pillCat = c => `<span class="badge cat-pill cat-${c}">${c}</span>`;
const pillLoad = v => `<span class="badge text-bg-${v<3?'success':v<5?'warning':'danger'}">${v} pts</span>`;
function toast(msg,variant="primary"){
  const t = $("#toast");
  t.className = `toast align-items-center text-bg-${variant} border-0`;
  $("#toastMsg").textContent = msg;
  new bootstrap.Toast(t,{delay:2200}).show();
}

/* ------------------- LÍDER ------------------- */
function renderEmployees(){
  const byGroup = employees.reduce((acc,e)=>((acc[e.group]??=[]).push(e),acc),{});
  $("#empList").innerHTML = Object.keys(byGroup).sort().map(g=>{
    const list = byGroup[g].sort((a,b)=>a.role.localeCompare(b.role)||a.name.localeCompare(b.name))
      .map(e=>`
        <li class="list-group-item d-flex justify-content-between align-items-center">
          <div>
            <strong>${e.name}</strong> ${badgeRole(e.role)}
            <div class="small text-muted">Tareas: ${countTasks(e.id)} · ${pillLoad(e.load)}</div>
            <div class="small">Variedad reciente: ${[...new Set(e.recentCats)].slice(-3).map(pillCat).join(" ")||'<span class="text-muted">—</span>'}</div>
          </div>
          <button class="btn btn-sm btn-outline-secondary" onclick="clearEmp('${e.id}')">Limpiar</button>
        </li>`).join("");
    return `<div class="mb-3"><h6 class="mb-2">Grupo <strong>${g}</strong></h6><ul class="list-group">${list}</ul></div>`;
  }).join("");
}
function renderTasks(){
  $("#taskList").innerHTML = tasks.map(t=>`
    <div class="list-group-item d-flex justify-content-between align-items-center">
      <div>
        <strong>${t.title}</strong> ${pillCat(t.cat)}
        <span class="badge text-bg-dark ms-2">${t.reqRole}</span>
        <span class="badge text-bg-warning ms-1">P${t.priority}</span>
        <span class="badge text-bg-info ms-1">E${t.effort}</span>
      </div>
      <div class="btn-group">
        <button class="btn btn-sm btn-outline-primary" onclick="openAssignModal('${t.id}')">Asignar…</button>
        <button class="btn btn-sm btn-outline-danger" onclick="removeTask('${t.id}')">Quitar</button>
      </div>
    </div>`).join("") || `<div class="list-group-item text-muted">Backlog vacío.</div>`;
}
function countTasks(empId){ return assignments.filter(a=>a.empId===empId && a.status!=="done").length; }

/* ---- Motor de sugerencias ---- */
function computeSuggestion(){
  if(!tasks.length) return null;
  const alpha = parseFloat($("#alpha").value);
  const maxTasks = parseInt($("#maxTasks").value,10);
  const varWindow = parseInt($("#varWindow").value,10);

  const maxPrio = Math.max(...tasks.map(x=>x.priority),1);
  const maxLoad = Math.max(...employees.map(x=>x.load),1);

  let best=null;
  for(const t of tasks){
    for(const e of employees){
      if(e.role!==t.reqRole) continue;
      if(countTasks(e.id)>=maxTasks) continue;

      const prio = t.priority / maxPrio;
      const load = maxLoad===0 ? 0 : (e.load/maxLoad);
      const recent = e.recentCats.slice(-varWindow);
      const diversityBonus = recent.includes(t.cat) ? 0 : 0.25;
      let score = alpha*prio + (1-alpha)*(1 - load) + diversityBonus;

      if(e.group==="A") score += 0.02;
      if(!best || score>best.score) best = {task:t, emp:e, score};
    }
  }
  return best;
}
let lastS=null;
function showSuggestion(s){
  const box = $("#suggBox");
  if(!s){ box.innerHTML = `<div class="text-muted">No hay combinación válida.</div>`; return; }
  box.innerHTML = `
    <div class="alert alert-primary">
      <div class="d-flex justify-content-between align-items-center">
        <div>
          <div><strong>Tarea:</strong> ${s.task.title} ${pillCat(s.task.cat)} <span class="badge text-bg-warning ms-1">P${s.task.priority}</span> <span class="badge text-bg-info ms-1">E${s.task.effort}</span></div>
          <div><strong>Colaborador sugerido:</strong> ${s.emp.name} ${badgeRole(s.emp.role)} · Carga ${pillLoad(s.emp.load)}</div>
        </div>
        <span class="badge text-bg-primary">Score ${s.score.toFixed(2)}</span>
      </div>
    </div>`;
}
function assignSuggestion(s){
  if(!s) return;
  // Asignación rápida a 1 colaborador (mantengo por si te sirve)
  assignments.push({taskId:s.task.id, empId:s.emp.id, status:"pending", category:s.task.cat});
  s.emp.load += s.task.effort;
  // Quitamos del backlog (la sugerencia asume consumo de la tarea)
  tasks = tasks.filter(x=>x.id!==s.task.id);
  cacheTask(s.task);
  renderTasks(); renderEmployees(); lastS=null; showSuggestion(null); refreshWorkerView();
}

/* ---- Modal de asignación (nuevo) ---- */
let currentAssignTask = null;

function openAssignModal(taskId){
  const t = tasks.find(x=>x.id===taskId);
  if(!t) return;
  currentAssignTask = t;
  $("#assignTaskId").value = t.id;
  $("#assignTaskTitle").textContent = t.title;
  $("#assignTaskMeta").textContent = `Rol requerido: ${t.reqRole} • Prioridad P${t.priority} • Esfuerzo E${t.effort} • Categoría ${t.cat}`;
  // llenar opciones: solo colaboradores con ese rol
  const pool = employees.filter(e=>e.role===t.reqRole);
  $("#assignSelect").innerHTML = pool.map(e=>{
    const cap = ` (Carga: ${countTasks(e.id)}, ${e.load} pts)`;
    return `<option value="${e.id}">${e.name}${cap} — G${e.group}</option>`;
  }).join("") || `<option disabled>No hay colaboradores para este rol</option>`;
  new bootstrap.Modal($("#assignModal")).show();
}

$("#assignForm").addEventListener("submit",(e)=>{
  e.preventDefault();
  if(!currentAssignTask) return;
  const selected = Array.from($("#assignSelect").selectedOptions).map(o=>o.value);
  if(!selected.length){ toast("Selecciona al menos un colaborador","warning"); return; }

  // Asignar a múltiples colaboradores: misma tarea → varias asignaciones
  selected.forEach(empId=>{
    assignments.push({taskId: currentAssignTask.id, empId, status:"pending", category: currentAssignTask.cat});
    const emp = employees.find(e=>e.id===empId);
    if(emp) emp.load += currentAssignTask.effort;
  });

  // Al asignar desde backlog, consumimos la tarea (se reparte a los seleccionados)
  cacheTask(currentAssignTask);
  tasks = tasks.filter(x=>x.id!==currentAssignTask.id);
  currentAssignTask = null;

  bootstrap.Modal.getInstance($("#assignModal")).hide();
  renderTasks(); renderEmployees(); refreshWorkerView();
  toast("Tarea asignada", "success");
});

/* ---- Incidencias ---- */
function renderIssues(){
  const list = $("#issuesList");
  if(!issues.length){ list.innerHTML = `<div class="list-group-item text-muted">Sin incidencias por ahora.</div>`; return; }
  list.innerHTML = issues.slice().reverse().map(i=>{
    const emp = employees.find(e=>e.id===i.empId);
    const t = TASK_CACHE[i.taskId] || {title:i.taskId};
    return `<div class="list-group-item">
      <div class="d-flex justify-content-between">
        <div>
          <div><strong>${emp?.name||i.empId}</strong> reporta: <em>${t.title}</em></div>
          <div class="small text-muted">${i.text}</div>
          <div class="small">Severidad: <span class="badge text-bg-${i.severity==='alta'?'danger':i.severity==='media'?'warning':'secondary'}">${i.severity}</span> · ${i.needHelp==='si'?'Requiere ayuda':''}</div>
        </div>
        <div class="text-end">
          <button class="btn btn-sm btn-outline-success" onclick="resolveIssue('${i.id}')">Resolver</button>
        </div>
      </div>
    </div>`;
  }).join("");
}
function resolveIssue(id){
  issues = issues.filter(x=>x.id!==id);
  renderIssues();
  toast("Incidencia resuelta", "success");
}

/* ------------------- ACCIONES LÍDER ------------------- */
function clearEmp(id){
  const emp = employees.find(e=>e.id===id);
  const back = assignments.filter(a=>a.empId===id && a.status!=="done").map(a=>a.taskId);
  tasks.push(...back.map(tid=>TASK_TPL[tid] ? {id:tid, ...TASK_TPL[tid]} : {id:tid,title:tid,reqRole:"Operativo",priority:3,effort:1,cat:"Servicio"}));
  assignments = assignments.filter(a=>!(a.empId===id && a.status!=="done"));
  emp.load = 0;
  renderTasks(); renderEmployees(); refreshWorkerView();
}
function removeTask(id){ tasks = tasks.filter(t=>t.id!==id); renderTasks(); }
const TASK_TPL = {};
const TASK_CACHE = {};
function cacheTask(t){ TASK_CACHE[t.id] = {...t}; TASK_TPL[t.id] = {title:t.title, reqRole:t.reqRole, priority:t.priority, effort:t.effort, cat:t.cat}; }

/* ------------------- COLABORADOR ------------------- */
function renderWorkerSelector(){
  $("#workerSelect").innerHTML = employees
    .filter(e=>e.role!=="Lider")
    .map(e=>`<option value="${e.id}" ${workerMeta.selected===e.id?'selected':''}>${e.name} — ${e.role} (G${e.group})</option>`).join("");
}
function tasksOf(empId){
  const ids = assignments.filter(a=>a.empId===empId && a.status!=="done").map(a=>a.taskId);
  return ids.map(id=> TASK_CACHE[id] || tasks.find(t=>t.id===id) || {id, title:"Tarea", reqRole:"Operativo", priority:3, effort:1, cat:"Servicio"} );
}
function renderMyTasks(){
  const me = employees.find(e=>e.id===workerMeta.selected);
  const list = assignments.filter(a=>a.empId===me.id && a.status!=="done")
    .map(a=>({a, t: TASK_CACHE[a.taskId] || tasks.find(x=>x.id===a.taskId) || {id:a.taskId,title:"Tarea",reqRole:me.role,priority:3,effort:1,cat:a.category}}));

  $("#myTasks").innerHTML = list.map(({a,t})=>`
    <div class="task-card mb-3">
      <div class="d-flex justify-content-between">
        <div class="title">${t.title} ${pillCat(t.cat)}</div>
        <div>
          <span class="badge text-bg-warning">P${t.priority}</span>
          <span class="badge text-bg-info ms-1">E${t.effort}</span>
        </div>
      </div>
      <div class="small text-muted mt-1">Rol: ${t.reqRole} · Estado: <strong>${a.status.toUpperCase()}</strong></div>
      <div class="d-flex gap-2 mt-2">
        <button class="btn btn-sm btn-success" onclick="toggleDone('${t.id}')">✔️ Marcar completada</button>
        <button class="btn btn-sm btn-outline-danger" onclick="openIssue('${t.id}')">🚩 Tengo un problema</button>
      </div>
    </div>`).join("") || `<div class="text-muted">Sin tareas asignadas por ahora.</div>`;

  const cats = [...new Set(list.map(x=>x.t.cat))];
  $("#diversityCats").innerHTML = cats.map(pillCat).join(" ") || `<span class="text-muted">—</span>`;
  $("#varietyHint").textContent = `Variedad: ${cats.length} categoría(s) diferentes en tus tareas actuales.`;

  $("#pointsBadge").textContent = `${me.points} pts`;
  $("#badgesBox").innerHTML = me.badges.map(b=>`<span class="badge text-bg-warning">${b}</span>`).join(" ") || `<span class="text-muted">Sin badges aún</span>`;
  $("#achievementsBox").innerHTML = me.achievements?.length ? me.achievements.map(a=>`<span class="badge text-bg-secondary me-1">${a}</span>`).join(" ") : "—";

  updateStreak(me);
}
function toggleDone(taskId){
  const me = employees.find(e=>e.id===workerMeta.selected);
  const idx = assignments.findIndex(a=>a.taskId===taskId && a.empId===me.id && a.status!=="done");
  if(idx<0) return;
  assignments[idx].status = "done";
  me.load = Math.max(0, me.load - (TASK_CACHE[taskId]?.effort || 1));
  const cat = assignments[idx].category;
  me.recentCats.push(cat);
  me.points += 10 + (["Bebidas","Comida","Servicio","QC"].indexOf(cat)+1);
  grantBadges(me);
  renderEmployees(); renderMyTasks();
  toast("¡Buen trabajo! Tarea completada ✅","success");
}
function openIssue(taskId){
  $("#issueTaskId").value = taskId;
  $("#issueText").value = "";
  $("#issueSeverity").value = "media";
  $("#issueNeedHelp").value = "si";
  new bootstrap.Modal($("#issueModal")).show();
}
$("#issueForm").addEventListener("submit",(e)=>{
  e.preventDefault();
  const me = employees.find(x=>x.id===workerMeta.selected);
  const id = "ISS"+Math.random().toString(36).slice(2,7).toUpperCase();
  const obj = { id, taskId: $("#issueTaskId").value, empId: me.id, text: $("#issueText").value.trim(),
                severity: $("#issueSeverity").value, needHelp: $("#issueNeedHelp").value, ts: Date.now(), status:"open" };
  issues.push(obj);
  assignments = assignments.map(a=> a.taskId===obj.taskId && a.empId===me.id ? {...a, status:"blocked"} : a);
  renderIssues(); renderMyTasks();
  bootstrap.Modal.getInstance($("#issueModal")).hide();
  toast("Incidencia enviada al líder","danger");
});

/* ---- Gamificación ---- */
function grantBadges(me){
  const diversity = new Set(me.recentCats.slice(-6)).size;
  if(diversity>=3 && !me.badges.includes("Todo Terreno")) me.badges.push("Todo Terreno");
  const doneToday = assignments.filter(a=>a.empId===me.id && a.status==="done").length;
  if(doneToday>=5 && !me.badges.includes("Alta Productividad")) me.badges.push("Alta Productividad");
}
function updateStreak(me){
  const doneToday = assignments.filter(a=>a.empId===me.id && a.status==="done").length;
  if(doneToday>=3) me.streak = Math.min(5, me.streak+1);
  const pct = (me.streak/5)*100;
  $("#streakBar").style.width = pct+"%";
  $("#streakBar").textContent = `${me.streak}/5`;
}

/* ------------------- FORM ADD TASK (MODAL) ------------------- */
$("#addTaskForm").addEventListener("submit",(e)=>{
  e.preventDefault();
  const obj = {
    id: "T"+Math.random().toString(36).slice(2,7).toUpperCase(),
    title: $("#fTitle").value.trim() || "Tarea",
    reqRole: $("#fRole").value,
    priority: Math.min(5,Math.max(1, parseInt($("#fPriority").value,10)||3)),
    effort: Math.min(3,Math.max(1, parseInt($("#fEffort").value,10)||1)),
    cat: CATS.includes($("#fCategory").value) ? $("#fCategory").value : "Servicio",
    notes: $("#fNotes").value.trim()
  };
  tasks.push(obj); cacheTask(obj);
  renderTasks();
  bootstrap.Modal.getInstance($("#addTaskModal")).hide();
  $("#addTaskForm").reset();
  toast("Tarea añadida al backlog","primary");
});

/* ------------------- HANDLERS GENERALES ------------------- */
$("#btnSuggest").addEventListener("click", ()=>{ lastS = computeSuggestion(); showSuggestion(lastS); });
$("#btnAssign").addEventListener("click", ()=>assignSuggestion(lastS));
let autoTimer=null;
$("#btnAuto").addEventListener("click", ()=>{
  if(autoTimer){ clearInterval(autoTimer); autoTimer=null; $("#btnAuto").textContent="Auto-asignar (demo)"; return; }
  $("#btnAuto").textContent="Detener auto";
  autoTimer = setInterval(()=>{ const s = computeSuggestion(); if(s) assignSuggestion(s); }, 3000);
});
$("#btnClearDone").addEventListener("click", ()=>{ assignments = assignments.filter(a=>a.status!=="done"); renderMyTasks(); renderEmployees(); });
$("#workerSelect").addEventListener("change",(e)=>{ workerMeta.selected=e.target.value; renderMyTasks(); });
$("#btnSeed").addEventListener("click", ()=>{ seed(); init(); toast("Datos de demo reestablecidos","secondary"); });

/* ------------------- INIT ------------------- */
function init(){
  tasks.forEach(cacheTask);
  renderEmployees();
  renderTasks();
  renderWorkerSelector();
  renderMyTasks();
  renderIssues();
}
init();
</script>
</body>
</html>
